{% extends "base.html" %}

{% block title %}{{ 'Edit' if interaction else 'New' }} Interaction - Effect CRM{% endblock %}

{% block styles %}
<style>
    .interaction-type-card {
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid #dee2e6;
    }
    .interaction-type-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .interaction-type-card.selected {
        border-color: var(--bs-primary);
        background-color: var(--bs-primary-bg-subtle);
    }
    .interaction-type-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    .datetime-picker {
        position: relative;
    }
    .datetime-picker .form-control {
        padding-left: 2.5rem;
    }
    .datetime-picker i {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
            {% if contact %}
            <li class="breadcrumb-item"><a href="{{ url_for('contacts.show', id=contact.id) }}">{{ contact.full_name }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{{ 'Edit' if interaction else 'New' }} Interaction</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">{{ 'Edit' if interaction else 'New' }} Interaction</h1>
            {% if contact %}
            <p class="text-muted mb-0">Creating interaction for {{ contact.full_name }}</p>
            {% endif %}
        </div>
    </div>

    <!-- Form -->
    <div class="card shadow-sm">
        <div class="card-body">
            <form method="POST" class="needs-validation" novalidate>
                {{ form.csrf_token }}
                {{ form.contact_id }}
                
                <!-- Mark as done section -->
                <div class="mark-as-done-section">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="mark_as_done" name="mark_as_done" 
                               {% if interaction and interaction.status == 'completed' %}checked{% endif %}>
                        <label class="form-check-label fw-bold" for="mark_as_done">
                            <i class="bi bi-check-circle-fill text-success"></i> Mark as done
                        </label>
                    </div>
                </div>

                <!-- Interaction Type Selection -->
                <div class="mb-4">
                    <label class="form-label">Interaction Type *</label>
                    <div class="row g-3">
                        {% for type_key, type_value in form.type.choices %}
                        <div class="col-md-3 col-sm-6">
                            <div class="card interaction-type-card h-100 {% if form.type.data == type_key %}selected{% endif %}" 
                                 data-type="{{ type_key }}" 
                                 onclick="selectInteractionType('{{ type_key }}')">
                                <div class="card-body text-center p-3">
                                    <div class="interaction-type-icon text-{{ Interaction.TYPE_COLORS.get(type_key, 'secondary') }}">
                                        <i class="fas fa-{{ Interaction.TYPE_ICONS.get(type_key, 'question-circle') }}"></i>
                                    </div>
                                    <h6 class="mb-0">{{ type_value }}</h6>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {{ form.type(id="selected_type", class="d-none") }}
                    <div class="invalid-feedback">Please select an interaction type.</div>
                </div>

                <!-- Title and Priority -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label for="title" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="{{ form.title.data or '' }}" required
                               placeholder="Brief title for this interaction">
                        <div class="invalid-feedback">Please provide a title.</div>
                    </div>
                    <div class="col-md-4">
                        <label for="priority" class="form-label">Priority *</label>
                        <select class="form-select" id="priority" name="priority" required>
                            {% for value, label in form.priority.choices %}
                            <option value="{{ value }}" {% if form.priority.data == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Please select a priority level.</div>
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="3"
                              placeholder="Detailed description of the interaction">{{ form.description.data or '' }}</textarea>
                </div>

                <!-- Location -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" name="location"
                               value="{{ form.location.data or '' }}"
                               placeholder="Meeting location or platform">
                    </div>
                </div>

                <!-- Date and Time -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="start_date" class="form-label">Date *</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ form.start_date.data.strftime('%Y-%m-%d') if form.start_date.data else '' }}" required>
                        <div class="invalid-feedback">Please select a date.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="start_time" class="form-label">Time *</label>
                        <input type="time" class="form-control" id="start_time" name="start_time" 
                               value="{{ form.start_time.data.strftime('%H:%M') if form.start_time.data else '' }}" required>
                        <div class="invalid-feedback">Please select a time.</div>
                    </div>
                </div>

                <!-- End Date and Time (for meetings) -->
                <div class="row mb-3 meeting-fields" style="display: none;">
                    <div class="col-md-6">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ form.end_date.data.strftime('%Y-%m-%d') if form.end_date.data else '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="end_time" class="form-label">End Time</label>
                        <input type="time" class="form-control" id="end_time" name="end_time" 
                               value="{{ form.end_time.data.strftime('%H:%M') if form.end_time.data else '' }}">
                    </div>
                </div>

                <!-- Status and Assignment -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="status" class="form-label">Status *</label>
                        <select class="form-select" id="status" name="status" required>
                            {% for status_key, status_value in form.status.choices %}
                            <option value="{{ status_key }}" {% if form.status.data == status_key %}selected{% endif %}>
                                {{ status_value }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="assigned_to_id" class="form-label">Assign To</label>
                        <select class="form-select" id="assigned_to_id" name="assigned_to_id">
                            <option value="">Select user...</option>
                            {% for user_id, user_name in form.assigned_to_id.choices %}
                            <option value="{{ user_id }}" {% if form.assigned_to_id.data == user_id %}selected{% endif %}>
                                {{ user_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Notes -->
                <div class="mb-3">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="2"
                              placeholder="Additional notes about the interaction">{{ form.notes.data or '' }}</textarea>
                </div>

                <!-- Outcome and Next Steps -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="outcome" class="form-label">Outcome</label>
                        <textarea class="form-control" id="outcome" name="outcome" rows="2"
                                  placeholder="What was the result of this interaction?">{{ form.outcome.data or '' }}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label for="next_steps" class="form-label">Next Steps</label>
                        <textarea class="form-control" id="next_steps" name="next_steps" rows="2"
                                  placeholder="What needs to be done next?">{{ form.next_steps.data or '' }}</textarea>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="d-flex justify-content-end gap-2">
                    <a href="{{ url_for('contacts.show', id=contact.id) if contact else url_for('interactions.index') }}" 
                       class="btn btn-outline-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Save Interaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle interaction type selection
    const typeCards = document.querySelectorAll('.interaction-type-card');
    const typeInput = document.getElementById('selected_type');
    
    typeCards.forEach(card => {
        card.addEventListener('click', function() {
            // Remove selected class from all cards
            typeCards.forEach(c => c.classList.remove('selected'));
            // Add selected class to clicked card
            this.classList.add('selected');
            // Update hidden input
            typeInput.value = this.dataset.type;
        });
    });

    // Set initial selection if editing
    const formTypeData = '{{ form.type.data|default("", true)|tojson|safe }}';
    if (formTypeData) {
        const initialCard = document.querySelector(`.interaction-type-card[data-type="${formTypeData}"]`);
        if (initialCard) {
            initialCard.classList.add('selected');
            typeInput.value = formTypeData;
        }
    }

    // Add mark as done functionality
    document.getElementById('mark_as_done').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('status').value = 'completed';
        } else {
            document.getElementById('status').value = 'scheduled';
        }
    });
});
</script>
{% endblock %} 